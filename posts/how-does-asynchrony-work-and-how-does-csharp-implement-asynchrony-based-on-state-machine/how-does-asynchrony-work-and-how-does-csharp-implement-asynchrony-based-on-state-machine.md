---
title: å¼‚æ­¥çš„åŸç†æ˜¯ä»€ä¹ˆï¼ŸC# å¦‚ä½•åŸºäºçŠ¶æ€æœºå®ç°å¼‚æ­¥ï¼Ÿ
slug: how-does-asynchrony-work-and-how-does-csharp-implement-asynchrony-based-on-state-machine
create_time: 2022-07-14 00:55:00
last_updated: 2022-08-13 19:29:00
description: æœ¬ç¯‡åšå®¢ä»‹ç»äº†ä»€ä¹ˆæ˜¯ C# å¼‚æ­¥çš„ç»­å»¶ï¼ˆcontinuationï¼‰ï¼Œé€šè¿‡ç»­å»¶ç®€å•ç†è§£å¼‚æ­¥çš„åŸç†ï¼Œä»¤ç‰Œ Taskï¼Œå¼‚æ­¥çš„æµç¨‹ï¼Œé€šè¿‡ç¼–è¯‘åçš„ä»£ç åˆ†æ C# å¦‚ä½•ä½¿ç”¨çŠ¶æ€æœºå®ç°å¼‚æ­¥ã€‚
tags:
  - CSharp
---

> å‚è€ƒèµ„æ–™ï¼š*C# in Depth, Fourth Edition* - Jon Skeet

[TOC]

## 1. é€šè¿‡ç»­å»¶ç®€å•ç†è§£å¼‚æ­¥çš„åŸç†

ä¸Šç¯‡æ–‡ç« æåˆ°äº†â€œç»­å»¶ï¼ˆcontinuationï¼‰â€è¿™ä¸ªæ¦‚å¿µï¼Œé€šè¿‡è§£é‡Šå®ƒï¼Œç®€å•è§£é‡Šä¸€ä¸‹å¼‚æ­¥çš„åŸç†ã€‚æå‰è¯´ä¸€ä¸‹ï¼ŒåŸç†ä¸ç­‰äºå®ç°ï¼Œå®é™…ä¸Š C# å®ç°å¼‚æ­¥çš„æ–¹å¼æ˜¯åŸºäºçŠ¶æ€æœºçš„ï¼Œç¨å¾®æœ‰ç‚¹å¤æ‚ã€‚

```c#
public static async Task Main()
{
    var sw = Stopwatch.StartNew();
    
    Console.WriteLine("1.Main: " + Thread.CurrentThread.ManagedThreadId);

    await Task.Delay(100);

    Console.WriteLine("2.Main: " + Thread.CurrentThread.ManagedThreadId);
    
    Console.WriteLine(sw.ElapsedMilliseconds);
}
```

è¾“å‡ºç»“æœï¼š

```bash
1.Main: 1
2.Main: 5
115
```

- åœ¨æ‰§è¡Œåˆ° `await Task.Delay(100);` å‰ï¼Œä»¥åŒæ­¥æ–¹å¼æ‰§è¡Œ
- å½“æ‰§è¡Œåˆ° `await Task.Delay(100);` æ—¶ï¼Œä¼šæ£€æŸ¥æ˜¯å¦å·²ç»å¾—åˆ° `Task.Delay(100);` çš„æ‰§è¡Œç»“æœï¼Œå¦‚æœæ²¡æœ‰å¾—åˆ°ç»“æœï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ª**ç»­å»¶**ï¼Œç„¶åç­‰å¾…ï¼Œç­‰å¾—åˆ°ç»“æœåï¼Œå°±æ‰§è¡Œè¯¥ç»­å»¶
- åœ¨è¯¥ä¾‹ä¸­ï¼Œç­‰å¾… 100ms åæ‰§è¡Œç»­å»¶ã€‚ç»­å»¶ä¼šæ‰§è¡Œæ–¹æ³•çš„å‰©ä½™å†…å®¹ï¼Œå³ä» `Console.WriteLine("2.Main: " + Thread.CurrentThread.ManagedThreadId);` ç»§ç»­æ‰§è¡Œ

## 2. ç»­å»¶ï¼ˆcontinuationï¼‰â€œæœ¬è´¨ä¸Šâ€æ˜¯ä»€ä¹ˆï¼Ÿâ€œå®é™…ä¸Šâ€æ˜¯ä»€ä¹ˆï¼ŸTask æ‰®æ¼”äº†ä»€ä¹ˆè§’è‰²ï¼Ÿ

**æ³¨æ„ï¼Œè¿™é‡Œè¯´çš„æ˜¯â€œæœ¬è´¨ä¸Šâ€ï¼Œä¸æ˜¯â€œå®é™…ä¸Šâ€ã€‚** å®é™…ä¸Š C# å®ç°å¼‚æ­¥çš„æ–¹å¼æ˜¯ç”¨äº† try-catch å’Œ switch-case ç­‰ã€‚

- ç»­å»¶â€œæœ¬è´¨ä¸Šâ€æ˜¯ä¸ªå›è°ƒå‡½æ•°ï¼ˆAction å§”æ‰˜ï¼‰ï¼Œå¼‚æ­¥æ“ä½œæ‰§è¡Œå®Œæˆåä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°
- åœ¨å¼‚æ­¥æ–¹æ³•ä¸­ï¼Œç»­å»¶è´Ÿè´£ç»´æŠ¤æ–¹æ³•çš„çŠ¶æ€ã€‚å°±åƒé—­åŒ…èƒ½æ•è·ï¼ˆç»´æŠ¤ï¼‰å˜é‡ä¸Šä¸‹æ–‡ä¸€æ ·ï¼Œç»­å»¶å¯ä»¥è®°å½•æ–¹æ³•æ‰§è¡Œçš„ä½ç½®ï¼Œæ–¹ä¾¿ä»¥åæ¢å¤æ–¹æ³•çš„æ‰§è¡Œ

ç»­å»¶â€œæœ¬è´¨ä¸Šâ€å°±æ˜¯å¯ä»¥ä¿å­˜ç¨‹åºæ‰§è¡ŒçŠ¶æ€çš„å›è°ƒï¼Œè´Ÿè´£æ¥æ”¶å¼‚æ­¥æ“ä½œçš„ç»“æœã€‚é¡ºå¸¦ä¸€æï¼Œ`Task.ContinueWith()` æ˜¯ç”¨æ¥é™„åŠ ç»­å»¶çš„æ–¹æ³•ã€‚

è®©ç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬åˆ›å»ºç»­å»¶ï¼Œæ˜¯ `await` å…³é”®å­—çš„ä½œç”¨ä¹‹ä¸€ã€‚

å‰é¢è¯´äº†ä¸€å †â€œæœ¬è´¨ä¸Šâ€ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œä½†å¯èƒ½å¼„å·§æˆæ‹™æŠŠè¯¸ä½ç»•æ™•äº†ã€‚ç°åœ¨è¯´ä¸€ä¸‹â€œå®é™…ä¸Šâ€ã€‚

- **ç»­å»¶å¹¶æ²¡æœ‰åƒå›è°ƒå‡½æ•°ä¸€æ ·ä¼ é€’ç»™å¼‚æ­¥æ–¹æ³•**ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯å¼‚æ­¥æ–¹æ³•æ‰§è¡Œå®Œæˆåè°ƒç”¨ç»­å»¶ï¼Œè€Œæ˜¯**å¼‚æ­¥æ“ä½œå‘èµ·å¹¶ä¸”è¿”å›äº†ä¸€ä¸ªâ€œä»¤ç‰Œâ€**ï¼Œè¿™ä¸ªâ€œä»¤ç‰Œâ€å¯è¢«ç»­å»¶ä½¿ç”¨
- â€œä»¤ç‰Œâ€é€šå¸¸å°±æ˜¯ `Task` æˆ– `Task<T>` ç±»å‹çš„å¯¹è±¡ï¼Œå³å¼‚æ­¥æ–¹æ³•è¿”å›çš„å¯¹è±¡ã€‚ä½†å¹¶ä¸å¼ºåˆ¶å¿…é¡»æ˜¯å®ƒä»¬ï¼Œå¼‚æ­¥æ–¹æ³•ä¹Ÿå¯ä»¥è¿”å›å…¶å®ƒç±»å‹æˆ– void
- â€œä»¤ç‰Œâ€ä»£è¡¨æ­£åœ¨æ‰§è¡Œçš„æ“ä½œï¼Œå®ƒå¯èƒ½åœ¨è¿”å›ç»™è°ƒç”¨æ–¹ä¹‹å‰å°±æ‰§è¡Œå®Œäº†ï¼Œä¹Ÿå¯èƒ½è¿˜åœ¨æ‰§è¡Œï¼Œä¹Ÿå¯èƒ½è¢«å–æ¶ˆäº†ã€‚å®ƒçš„çŠ¶æ€ï¼ˆStatusï¼‰æ˜¯ `Task.Status` å±æ€§
- â€œä»¤ç‰Œâ€ç”¨äºé€šçŸ¥è°ƒç”¨æ–¹åœ¨è¯¥æ“ä½œå®Œæˆä¹‹å‰ä¸èƒ½è¿›è¡Œåç»­çš„å¤„ç†æ“ä½œ

## 3. å¼‚æ­¥çš„æµç¨‹

æ‰¯åˆ°è¿™é‡Œï¼Œå°±å¯ä»¥ç®€å•è¯´ä¸€ä¸‹å¼‚æ­¥çš„æµç¨‹äº†ï¼š

1. æ‰§è¡ŒæŸä¸ªæ–¹æ³•ï¼Œä¾‹å¦‚ `Main()`
2. ä¸€ç›´æ‰§è¡Œåˆ°ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œå¯åŠ¨è¿™ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œå¼‚æ­¥æ–¹æ³•ä¼šç«‹åˆ»è¿”å›ä¸€ä¸ªä»¤ç‰Œï¼Œæ‹¿åˆ°è¿™ä¸ªä»¤ç‰Œ
3. æ‰§è¡Œä¸€äº›å…¶å®ƒçš„åŒæ­¥æˆ–å¼‚æ­¥çš„æ“ä½œï¼Œä¹Ÿå¯ä»¥ä»€ä¹ˆéƒ½ä¸åš
4. é€šè¿‡â€œä»¤ç‰Œâ€ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆï¼ˆawaitï¼‰
5. æ‰§è¡Œå…¶å®ƒæ“ä½œï¼ŒåŒ…æ‹¬å¼‚æ­¥æ“ä½œçš„åç»­æ“ä½œï¼Œå³ç»­å»¶ä¸­çš„æ“ä½œ

åœ¨ï¼ˆ1. é€šè¿‡ç»­å»¶ç®€å•ç†è§£å¼‚æ­¥çš„åŸç†ï¼‰å¼€å¤´é‚£æ®µç¤ºä¾‹ä»£ç ä¸­ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨ç¬¬ 4 æ­¥å¡ 100msï¼Œawait è¯­å¥é€šè¿‡ `Task.Delay(100)` è¿™ä¸ªå¼‚æ­¥æ–¹æ³•è¿”å›çš„â€œä»¤ç‰Œâ€ Task æ¥ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆã€‚

ç¤ºä¾‹ä»£ç å¯èƒ½ä¸å¤ªæ˜æ˜¾ï¼Œåƒä¸‹é¢è¿™æ ·å†™å°±å¾ˆæ˜æ˜¾äº†ï¼Œè¿™é‡Œçš„ `Task t` å°±æ˜¯å¼‚æ­¥æ“ä½œè¿”å›çš„â€œä»¤ç‰Œâ€ï¼š

```c#
public static async Task Main()
{
    Console.WriteLine("1.Main: " + Thread.CurrentThread.ManagedThreadId);
    
    Task t = Task.Delay(100);
    
    await t;
    
    Console.WriteLine("2.Main: " + Thread.CurrentThread.ManagedThreadId);
}
```

ä½ å®Œå…¨å¯ä»¥åœ¨ `Task t = Task.Delay(100);`è¯­å¥å’Œ `await t;` è¯­å¥ä¹‹é—´æ’å…¥ä¸€äº›å…¶å®ƒçš„ä»£ç ï¼Œç›¸å½“äºä½ ç‚¹å¤–å–ï¼Œå«äº†ä¸€ä»½é»„ç„–é¸¡ç±³é¥­ï¼Œç„¶åå»åšåˆ«çš„äº‹äº†ï¼Œç­‰å…¶å®ƒäº‹æƒ…åšå®Œï¼Œè€Œä¸”é¥­é€åˆ°ä¹‹åï¼ˆå‡è®¾éª‘æ‰‹å¯ä»¥ç­‰ä½ åšå®Œå…¶å®ƒäº‹å†å¼€é—¨å–é¤ï¼‰ï¼Œå†å›æ¥å¤„ç†é»„ç„–é¸¡ç±³é¥­é€åˆ°ä¹‹åçš„ç»­å»¶ï¼Œæ¯”å¦‚ååˆ°æ¡Œå‰åƒé¥­ã€‚

å¦‚æœç›´æ¥ `await Task.Delay(100);` æˆ–è€… `Task.Delay(100).Wait();`ï¼Œå°±ä¼šä¸€ç›´ç­‰å¾… Delay 100ms ä¹‹åæ‰ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚å°±ç›¸å½“äºä½ å«äº†ä»½é»„ç„–é¸¡ç±³é¥­ï¼Œç„¶åä½ åç­‰éª‘æ‰‹æ¥é€é¤ï¼ŒæœŸé—´ä»€ä¹ˆéƒ½ä¸åšã€‚

## 4. ç­‰å¾…å¼‚æ­¥æ–¹æ³•ï¼ˆawaitï¼‰ä¸ºä»€ä¹ˆèƒ½å¤Ÿä¸é˜»å¡çº¿ç¨‹ï¼Ÿ

**å› ä¸ºæ­£åœ¨è¢«è°ƒç”¨çš„å¼‚æ­¥æ–¹æ³•é‡åˆ° await åç«‹åˆ»è¿”å›äº†ï¼ˆä»¤ç‰Œï¼‰ã€‚** å¯¹è°ƒç”¨æ–¹æ¥è¯´ç›¸å½“äºè°ƒç”¨å¼‚æ­¥æ–¹æ³•çš„è¿™è¡Œä»£ç ç«‹åˆ»æ‰§è¡Œå®Œäº†ã€‚

å¼‚æ­¥æ–¹æ³•**ç«‹å³è¿”å›**ä¸€ä¸ªä»¤ç‰Œï¼Œä¹‹åå¼‚æ­¥æ–¹æ³•ç»§ç»­æ‰§è¡Œç€ï¼Œè°ƒç”¨æ–¹æ‹¿ç€å¼‚æ­¥æ“ä½œè¿”å›çš„â€œä»¤ç‰Œâ€ï¼Œå°±èƒ½çŸ¥é“å¼‚æ­¥æ“ä½œä½•æ—¶èƒ½å®Œæˆï¼Œç„¶ååšå‡ºè‡ªå·±æ¥ä¸‹æ¥è¦æ‰§è¡Œæ“ä½œè¿˜æ˜¯è¦ç­‰å¾…ç­‰é€‰æ‹©ã€‚

## 5. å¼‚æ­¥å®é™…ä¸Šçš„åŸç†

ä»é€»è¾‘ä¸Šç†è§£å¾ˆç®€å•ï¼Œä½†å®é™…ä¸Šç¼–è¯‘å™¨åšäº†å¾ˆå¤šå¾ˆéš¾ç†è§£çš„äº‹ã€‚æˆ‘åœ¨ä»¥å‰å°±å°è¯•è¿‡åç¼–è¯‘å¼‚æ­¥ä»£ç æ¥çœ‹çœ‹å®ƒåˆ°åº•æ•´äº†å•¥æ´»ï¼Œä½†æ˜¯åªçœ‹åˆ°ä¸€å † switch-case å’Œ gotoã€‚

æ¯”å¦‚çœ‹è¿™æ®µä»£ç ï¼š

```c#
static async Task PrintAndWait(TimeSpan delay)
{
    Console.WriteLine("Before first delay");
    await Task.Delay(delay);
    Console.WriteLine("Between delays");
    await Task.Delay(delay);
    Console.WriteLine("After second delay");
}

static void Main()
{
    PrintAndWait(TimeSpan.FromSeconds(1)).Wait();
}
```

è¿™æ®µä»£ç æ¥è‡ª *C# in Depth, Fourth Edition*ï¼Œä¹¦çš„ä½œè€…å¤§æ…ˆå¤§æ‚²åœ°æŠŠç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ç¿»è¯‘æˆäº†äººè¯ï¼Œè®©æˆ‘ä»¬èƒ½çœ‹æ‡‚ï¼Œè‡³å°‘èƒ½çœ‹æ‡‚å˜é‡åå’Œæ–¹æ³•åã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç ï¼Œä¸€äº›ç»™æˆ‘ä»¬ç†è§£ä»£ç é€ æˆéšœç¢çš„ Attribute æˆ‘å·²ç»åˆ æ‰äº†ã€‚

## 6. çŠ¶æ€æœº

å¼‚æ­¥å®ç°çš„åŸç†åŸºäºçŠ¶æ€æœºã€‚

### çŠ¶æ€æœºçš„çŠ¶æ€

çŠ¶æ€å½“ç„¶æ˜¯çŠ¶æ€æœºæœ€é‡è¦çš„éƒ¨åˆ†ï¼Œæ¯•ç«Ÿå®ƒå°±å«â€œçŠ¶æ€â€æœºã€‚

|![å›¾ 1 - çŠ¶æ€æœºçš„çŠ¶æ€](assets/2022-08-13-15-26-22.png)|
|:--:|
|<b>å›¾ 1 - çŠ¶æ€æœºçš„çŠ¶æ€</b>|

å¯ä»¥åˆ†ä¸ºè¿™ 4 ç§çŠ¶æ€ã€‚ä½†å¼‚æ­¥æ–¹æ³•ä¸­æ¯ä¸ª await è¡¨è¾¾å¼æ˜¯å•ç‹¬çš„æš‚åœçŠ¶æ€ï¼Œå³å¯èƒ½æœ‰å¤šä¸ªæš‚åœçŠ¶æ€ï¼Œæ¯æ¬¡ await è¡¨è¾¾å¼è¿”å›åéƒ½ä¼šè§¦å‘åç»­ä»£ç çš„æ‰§è¡Œã€‚æ¯æ¬¡çŠ¶æ€æœºéœ€è¦æš‚åœçš„æ—¶å€™å°±è®°å½•ä¸‹çŠ¶æ€ï¼Œä¸ºäº†å°†æ¥èƒ½ä»å½“å‰æ‰§è¡Œä½ç½®æ¢å¤æ‰§è¡Œã€‚ç°åœ¨å¬èµ·æ¥å¾ˆæŠ½è±¡ï¼Œåé¢æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ä»£ç å°±çŸ¥é“äº†ã€‚

state æ˜¯ int ç±»å‹ï¼Œå®ƒæœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ï¼š
- -1ï¼šå°šæœªå¯åŠ¨/æ­£åœ¨æ‰§è¡Œ
- -2ï¼šæ‰§è¡Œå®Œæˆ/æ‰§è¡Œå‡ºé”™
- å…¶ä»–å€¼ï¼šæ­£åœ¨æŸä¸ª await è¡¨è¾¾å¼å¤„æš‚åœ

ä¸ºä»€ä¹ˆâ€œå°šæœªå¯åŠ¨â€å’Œâ€œæ­£åœ¨æ‰§è¡Œâ€çŠ¶æ€ç”¨åŒä¸€ä¸ªå€¼è¡¨ç¤ºï¼Ÿåé¢è®²å®ŒçŠ¶æ€æœºæˆ‘å†è§£é‡Šã€‚

ä¸ºä»€ä¹ˆâ€œæ‰§è¡Œå®Œæˆâ€å’Œâ€œæ‰§è¡Œå‡ºé”™â€çŠ¶æ€ç”¨åŒä¸€ä¸ªå€¼è¡¨ç¤ºï¼Ÿå› ä¸ºå¯¹ä¸çŠ¶æ€æœºæ¥è¯´ï¼Œè¿™ä¸¤ç§æƒ…å†µéƒ½å±äºæ‰§è¡Œå®Œäº†ï¼Œå†æ²¡å®ƒä»€ä¹ˆäº‹äº†ã€‚

### çŠ¶æ€æœºç»“æ„ä½“

ç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ª private çš„ç»“æ„ä½“ `PrintAndWaitStateMachine` ä»£è¡¨å¼‚æ­¥æ–¹æ³•ï¼š

```c#
private struct PrintAndWaitStateMachine : IAsyncStateMachine
{
    public int state; // çŠ¶æ€æœºçš„çŠ¶æ€ï¼ˆéœ€è¦æ¢å¤çš„ä½ç½®ï¼‰
    public AsyncTaskMethodBuilder builder; // é€šç”¨å¼‚æ­¥åŸºç¡€æ¶æ„ç±»å‹å…³è”çš„ builder
    private TaskAwaiter awaiter; // å½“æ¢å¤æ‰§è¡Œæ—¶ç”¨äºè·å–ç»“æœçš„ awaiter
    public TimeSpan delay; // åŸå§‹æ–¹æ³•å‚æ•°

    // çŠ¶æ€æœºä¸»è¦çš„å·¥ä½œä»£ç 
    void IAsyncStateMachine.MoveNext()
    {
        // æš‚æ—¶çœç•¥......
    }
    
    void IAsyncStateMachine.SetStateMachine(IAsyncStateMachine stateMachine)
    {
        this.builder.SetStateMachine(stateMachine); // è¿æ¥ builder å’Œè£…ç®±åçš„çŠ¶æ€æœº
    }
}
```

**ç”±äºæˆ‘ä»¬æ˜¯åŸºäºå‘å¸ƒçš„æ„å»ºï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ç”Ÿæˆçš„æ˜¯ç»“æ„ä½“ã€‚å¦‚æœæˆ‘ä»¬åŸºäºè°ƒè¯•æ„å»ºï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ª classã€‚ä¸¤è€…ä¸»è¦æ˜¯æ€§èƒ½ä¸Šçš„åŒºåˆ«ã€‚**

åœ¨åˆ†æçŠ¶æ€æœºç»“æ„ä½“ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è´Ÿè´£åˆ›å»ºçŠ¶æ€æœºå¯¹è±¡çš„å­˜æ ¹æ–¹æ³•ã€‚

### å­˜æ ¹æ–¹æ³•ï¼ˆstub methodï¼‰

```c#
private static unsafe Task PrintAndWait(TimeSpan delay)
{
    // åˆå§‹åŒ–çŠ¶æ€æœº
    var machine = new PrintAndWaitStateMachine
    {
        delay = delay,
        builder = AsyncTaskMethodBuilder.Create(),
        state = -1
    };

    // è¿è¡ŒçŠ¶æ€æœºï¼Œç›´åˆ°å®ƒéœ€è¦ç­‰å¾…æ—¶
    machine.builder.Start(ref machine);

    // è¿”å›ä»£è¡¨å¼‚æ­¥æ“ä½œçš„ Task
    return machine.builder.Task;            
}
```

- `delay` æœ¬æ˜¯ `PrintAndWait(TimeSpan delay)` æ–¹æ³•çš„å½¢å‚ï¼Œè¢«ç¼–è¯‘æˆçŠ¶æ€æœºç»“æ„ä½“çš„ä¸€ä¸ªå­—æ®µ
- `builder` å–å†³äº async æ–¹æ³•è¿”å›ç±»å‹ã€‚å¯ä»¥ä½¿ç”¨ builder æ¥ç”ŸæˆæˆåŠŸä¿¡æ¯æˆ–å¤±è´¥ä¿¡æ¯ï¼Œå¤„ç† await ç­‰ï¼Œå®ƒå¯ç†è§£ä¸º helper
- `state` åˆå§‹çŠ¶æ€ä¸º -1

å¼‚æ­¥å®ç°çš„åŸç†åŸºäºçŠ¶æ€æœºã€‚ç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ª private çš„åµŒå¥—ç»“æ„ä½“ `PrintAndWaitStateMachine` ä»£è¡¨å¼‚æ­¥æ–¹æ³•ï¼Œä¹Ÿå°±éœ€è¦ä¸€ä¸ªå­˜æ ¹æ–¹æ³• `PrintAndWait()` æ¥æ„å»ºç»“æ„ä½“å¯¹è±¡ã€‚è¯¥å­˜æ ¹æ–¹æ³•ä¸åŸæ–¹æ³•åŒåï¼Œå®ƒæ˜¯ä¸€åˆ‡çš„å¼€å§‹ã€‚

é€šè¿‡è§‚å¯Ÿå­˜æ ¹æ–¹æ³•çš„ä»£ç ï¼Œåˆ†æä¸€ä¸‹å®ƒåšçš„äº‹ï¼š

1. åˆå§‹åŒ–çŠ¶æ€æœºï¼Œå¾—åˆ°ä¸€ä¸ªçŠ¶æ€æœºå¯¹è±¡
2. è°ƒç”¨çŠ¶æ€æœºçš„ builder çš„ `Start()` æ–¹æ³•æ¥å¯åŠ¨çŠ¶æ€æœºï¼ŒåŒæ—¶æŠŠçŠ¶æ€æœºå¯¹è±¡æœ¬èº«ä½œä¸ºå‚æ•°ä¼ ç»™å®ƒï¼ˆå¼•ç”¨ä¼ é€’ï¼Œä¸ºäº†ä¿è¯ state ç­‰å­—æ®µä¸€è‡´ï¼‰
3. è¿”å› builder çš„ Taskï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å‰é¢è¯´è¿‡çš„â€œå¼‚æ­¥æ–¹æ³•ç«‹å³è¿”å›â€çš„é‚£ä¸€åˆ»ã€‚

è¿™æ ·åœ¨è¿è¡Œ `Start()` æ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼ŒçŠ¶æ€æœº machine çš„ state çš„å˜åŒ–å°±ä¼šç›´æ¥åæ˜ åœ¨ machine è¿™ä¸ªå¯¹è±¡ä¸Šï¼Œæˆ‘ä»¬ä¸éœ€è¦è®© Start è¿”å›ä»€ä¹ˆå€¼ï¼Œæˆ‘ä»¬åªéœ€è¦å– machine çš„å€¼å°±çŸ¥é“ Start æ‰§è¡Œåˆ°ä»€ä¹ˆæƒ…å†µäº†ã€‚

å‰é¢æˆ‘ä»¬çŠ¶æ€æœºç»“æ„ä½“ä»£ç ä¸­æœ‰ä¸€ä¸ªæœ€é‡è¦çš„ `MoveNext()` æ–¹æ³•ã€‚çŠ¶æ€æœº start ä¹‹åä¸ä¼šåˆ›å»ºæ–°çº¿ç¨‹ï¼Œåªæ˜¯æ‰§è¡Œ `MoveNext()` æ–¹æ³•ï¼Œæ‰§è¡Œåˆ°çŠ¶æ€æœº await å¦ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•æˆ–è€…çŠ¶æ€æœºåœæ­¢ä¸ºæ­¢ã€‚ä¸ç®¡æ˜¯å“ªç§ï¼Œ`MoveNext()` éƒ½ä¼šè¿”å›ï¼Œå­˜æ ¹æ–¹æ³•ä¸­è°ƒç”¨çš„ `Start()` ä¹Ÿä¼šè¿”å›ã€‚è¿™æ ·å°±å¯ä»¥æŠŠ Task ä½œä¸ºæ•´ä¸ªå¼‚æ­¥æ–¹æ³•çš„ç»“æœè¿”å›ç»™è°ƒç”¨æ–¹ã€‚

### çŠ¶æ€æœºçš„ç»“æ„

è¿™é‡Œæˆ‘é‡æ–°è´´ä¸€ä¸‹çŠ¶æ€æœºçš„ä»£ç ï¼š

```c#
private struct PrintAndWaitStateMachine : IAsyncStateMachine
{
    public int state; // çŠ¶æ€æœºçš„çŠ¶æ€ï¼ˆéœ€è¦æ¢å¤çš„ä½ç½®ï¼‰
    public AsyncTaskMethodBuilder builder; // é€šç”¨å¼‚æ­¥åŸºç¡€æ¶æ„ç±»å‹å…³è”çš„ builder
    private TaskAwaiter awaiter; // å½“æ¢å¤æ‰§è¡Œæ—¶ç”¨äºè·å–ç»“æœçš„ awaiter
    public TimeSpan delay; // åŸå§‹æ–¹æ³•å‚æ•°

    // çŠ¶æ€æœºä¸»è¦çš„å·¥ä½œä»£ç 
    void IAsyncStateMachine.MoveNext()
    {
        // æš‚æ—¶çœç•¥......
    }
    
    void IAsyncStateMachine.SetStateMachine(IAsyncStateMachine stateMachine)
    {
        this.builder.SetStateMachine(stateMachine); // è¿æ¥ builder å’Œè£…ç®±åçš„çŠ¶æ€æœº
    }
}
```

- å®ç°äº† `IAsyncStateMachine` æ¥å£ï¼Œè¯¥æ¥å£æœ‰ `MoveNext()` å’Œ `SetStateMachine(IAsyncStateMachine stateMachine)` æ–¹æ³•
- å„å­—æ®µä¿å­˜äº†çŠ¶æ€æœºæ­¥è¿›æ—¶éœ€è¦çš„ä¿¡æ¯
- çŠ¶æ€æœºå¯åŠ¨æ—¶ä»¥åŠä»â€œæš‚åœçŠ¶æ€â€æ¢å¤åˆ°â€œè¿è¡ŒçŠ¶æ€â€åä¼šè°ƒç”¨ `MoveNext()`

åœ¨å®Œæˆä¸€äº›å†…éƒ¨äº‹åŠ¡ä¹‹åï¼Œ`Start()` æ–¹æ³•ä¼šè°ƒç”¨ `MoveNext()` æ–¹æ³•æ¥è¿ˆå‡ºå¼‚æ­¥æ–¹æ³•çš„ç¬¬ä¸€æ­¥ã€‚

ç»“æ„ä½“ä¸­è¿˜æœ‰å‡ ä¸ªå­—æ®µï¼Œå¦‚å‰é¢è®²è¿‡çš„ `state` ç­‰ã€‚çŠ¶æ€æœºä»æŸä¸ªæš‚åœçŠ¶æ€æ¢å¤æ—¶å¯èƒ½ä¼šå–è¿™äº›å­—æ®µçš„å€¼ã€‚

ç®€å•è¯´ä¸€ä¸‹ `awaiter` è¿™ä¸ªå­—æ®µã€‚ä»»ä½•ç‰¹å®šçš„çŠ¶æ€æœºä¸€æ¬¡åªèƒ½ await ä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥æ¯ä¸ªæ³›å‹ Task ä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªä¸è¿™ä¸ªæ³›å‹ç›¸å…³çš„ awaiterã€‚ä¾‹å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª async æ–¹æ³•ï¼Œé‡Œé¢ä¸€å…±æœ‰ 6 ä¸ª await è¯­å¥ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªæ˜¯ await `Task<int>` ç±»å‹çš„è¿”å›ï¼Œä¸€ä¸ª `await Task<string>`ï¼Œä¸‰ä¸ª `await Task`ï¼Œé‚£ä¹ˆå°±ä¼šç¼–è¯‘æˆ 3 ä¸ª awaiter å­—æ®µï¼Œä»–ä»¬çš„ç±»å‹åˆ†åˆ«æ˜¯ï¼š`TaskAwaiter<int>`ï¼Œ`TaskAwaiter<string>`ï¼Œ`TaskAwaiter`ã€‚åœ¨è¿™ 6 æ¬¡ await æ—¶ä¼šå¤ç”¨è¿™ä¸‰ä¸ªå­—æ®µã€‚

### `MoveNext()`

ç°åœ¨æ¥çœ‹ä¸€ä¸‹æœ€é‡è¦çš„ `MoveNext()` æ–¹æ³•ã€‚

ä¸ºäº†é˜²æ­¢å¿˜è®°ï¼Œå…ˆæ”¾ä¸€ä¸‹åŸæ–¹æ³•çš„ä»£ç ï¼š

```c#
static async Task PrintAndWait(TimeSpan delay)
{
    Console.WriteLine("Before first delay");
    await Task.Delay(delay);
    Console.WriteLine("Between delays");
    await Task.Delay(delay);
    Console.WriteLine("After second delay");
}
```

ç„¶åçœ‹ä¸€ä¸‹ `MoveNext()` çš„ä»£ç ï¼š

```c#
void IAsyncStateMachine.MoveNext()
{
    int num = this.state;
    try
    {
        TaskAwaiter awaiter1;
        switch (num)
        {
            default:
                goto MethodStart;
            // case çš„æ•°é‡ä¸ await è¡¨è¾¾å¼çš„æ•°é‡ç›¸ç­‰
            case 0:
                goto FirstAwaitContinuation;
            case 1:
                goto SecondAwaitContinuation;
        }
    MethodStart:
        Console.WriteLine("Before first delay"); // ç¬¬ä¸€ä¸ª await è¡¨è¾¾å¼ä¹‹å‰çš„ä»£ç 
        awaiter1 = Task.Delay(this.delay).GetAwaiter();
        if (awaiter1.IsCompleted)
        {
            goto GetFirstAwaitResult;
        }
        this.state = num = 0; // è®¾ç½®çŠ¶æ€æœºçŠ¶æ€
        this.awaiter = awaiter1; // è®¾ç½®ç¬¬ä¸€ä¸ª awaiter
        this.builder.AwaitUnsafeOnCompleted(ref awaiter1, ref this);
        return;
    FirstAwaitContinuation: // ä»ç»­å»¶ä¸­æ¢å¤æ‰§è¡Œçš„ä»£ç 
        awaiter1 = this.awaiter;
        this.awaiter = default(TaskAwaiter);
        this.state = num = -1;
    GetFirstAwaitResult: // å¿«é€Ÿè·¯å¾„å’Œæ…¢é€Ÿè·¯å¾„æ±‡åˆå¤„
        awaiter1.GetResult();
    // ğŸ‘‡ å‰©ä½™ä»£ç ï¼ŒåŒ…æ‹¬æ›´å¤šçš„æ ‡ç­¾ä»¥åŠ awaiter ç­‰
        Console.WriteLine("Between delays");
        TaskAwaiter awaiter2 = Task.Delay(this.delay).GetAwaiter();
        if (awaiter2.IsCompleted)
        {
            goto GetSecondAwaitResult;
        }
        this.state = num = 1;
        this.awaiter = awaiter2;
        this.builder.AwaitUnsafeOnCompleted(ref awaiter2, ref this);
        return;
    SecondAwaitContinuation:
        awaiter2 = this.awaiter;
        this.awaiter = default(TaskAwaiter);
        this.state = num = -1;
    GetSecondAwaitResult:
        awaiter2.GetResult();
        Console.WriteLine("After second delay");
    }
    catch (Exception exception)
    {
        // æ‰§è¡Œå‡ºé”™
        this.state = -2;
        this.builder.SetException(exception); // é€šè¿‡ builder å¡«å……å¼‚å¸¸ä¿¡æ¯
        return;
    }
    // æ­£å¸¸æ‰§è¡Œå®Œæˆ
    this.state = -2;
    this.builder.SetResult(); // é€šè¿‡ builder å¡«å……æ–¹æ³•å®Œæˆçš„ä¿¡æ¯
}
```

è¿‡ä¸€éä»£ç ï¼Œä¼°è®¡æœ‰çš„æœ‹å‹å°±çœ‹æ‡‚äº†è¿™å¼‚æ­¥æ˜¯æ€ä¹ˆå®ç°çš„äº†ã€‚

1. **`MoveNext()` æ–¹æ³•ä¼šåœ¨ async æ–¹æ³•ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶è¢«è°ƒç”¨ï¼Œç„¶åæ¯æ¬¡æ¢å¤æ‰§è¡Œæ—¶éƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚**
2. åœ¨ await è¡¨è¾¾å¼æ—¶ï¼Œæœ‰ä¸¤ç§å¯èƒ½ï¼Œawait çš„å¼‚æ­¥æ“ä½œå°šæœªå®Œæˆï¼Œæˆ–è€…å·²ç»å®Œæˆã€‚ä¾‹å¦‚ä¸Šé¢ä»£ç ä¸­ï¼š
```c#
MethodStart:
    Console.WriteLine("Before first delay");
    awaiter1 = Task.Delay(this.delay).GetAwaiter();
    // ä¸¤ç§å¯èƒ½
    if (awaiter1.IsCompleted)
    {
        goto GetFirstAwaitResult;
    }
    this.state = num = 0;
    this.awaiter = awaiter1;
    this.builder.AwaitUnsafeOnCompleted(ref awaiter1, ref this);
    return;
FirstAwaitContinuation:
    // ......
GetFirstAwaitResult:
    awaiter1.GetResult();
    Console.WriteLine("Between delays");
    // ......
```
å¦‚æœ `awaiter1` ç­‰å¾…çš„å¼‚æ­¥æ“ä½œå·²ç»å®Œæˆï¼Œå³ `awaiter1.IsCompleted == true`ï¼Œå°±ä¼šç›´æ¥è¿è¡Œ `goto GetFirstAwaitResult;`ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥è¿è¡Œä¸‹é¢çš„ `GetFirstAwaitResult:` ä»£ç å—ã€‚è¿™è¢«ç§°ä¸º**å¿«é€Ÿè·¯å¾„ï¼ˆfast pathï¼‰**ã€‚

å¦‚æœå¹¶æœªå®Œæˆï¼Œå³ `awaiter1.IsCompleted == false`ï¼Œå°±ä¼šç»§ç»­å¾€ä¸‹èµ°ï¼ŒçŠ¶æ€æœºè¿›å…¥æš‚åœçŠ¶æ€ï¼ŒçŠ¶æ€æœºçš„ state å­—æ®µè¢«ç½®ä¸º 0ï¼Œawaiter å­—æ®µè¢«ç½®ä¸ºè¿˜åœ¨ç­‰çš„ awaiter1ï¼Œæœ€å returnã€‚ä¸€ç›´ç­‰åˆ°çŠ¶æ€æœºæ¢å¤æ‰§è¡Œæ—¶ï¼Œ`MoveNext()` æ–¹æ³•å†æ¬¡è¢«è°ƒç”¨ï¼Œè¿›å…¥ switch-case è¯­å¥ï¼š
```c#
switch (num)
{
    default:
        goto MethodStart;
    case 0:
        goto FirstAwaitContinuation;
    case 1:
        goto SecondAwaitContinuation;
}
```

å› ä¸º num å–çš„ state çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ 0ï¼Œæ‰€ä»¥ç›´æ¥ `goto FirstAwaitContinuation;`ï¼Œä»£ç èµ°è¿›äº† FirstAwait çš„**ç»­å»¶ï¼ˆæœ€å¼€å§‹æåˆ°çš„ç»­å»¶æ¦‚å¿µï¼‰**ï¼Œä¹Ÿå°±æ˜¯ä»£ç èµ°è¿›äº† `FirstAwaitContinuation:` ä»£ç å—ï¼š
```c#
FirstAwaitContinuation:
    awaiter1 = this.awaiter;
    this.awaiter = default(TaskAwaiter);
    this.state = num = -1;
GetFirstAwaitResult:
    awaiter1.GetResult();
    Console.WriteLine("Between delays");
    // ......
```
`FirstAwaitContinuation:` ä»£ç å—å°±èµ‹å€¼ä¸€ä¸‹å˜é‡ï¼Œè°ƒæ•´ä¸€ä¸‹çŠ¶æ€åˆ° -1ï¼ˆå°šæœªå¯åŠ¨/æ­£åœ¨æ‰§è¡Œï¼‰ï¼Œå°±æ˜¯åšäº†ä¸€äº›çŠ¶æ€æœºæ¢å¤è¿è¡Œåçš„å‡†å¤‡æ“ä½œï¼Œç„¶åå°±åˆèµ°è¿›äº† `GetFirstAwaitResult:` ä»£ç å—ã€‚è·Ÿ**å¿«é€Ÿè·¯å¾„**äº¤æ±‡ã€‚è¿™å«åš**æ…¢é€Ÿè·¯å¾„ï¼ˆslow pathï¼‰**ã€‚

å¦‚æœæˆ‘ä»¬ Delay çš„ä¸€ç›´æ˜¯ 0msï¼Œæˆ–è€… await çš„ä¸€ç›´éƒ½æ˜¯å·²ç»å®Œæˆçš„å¼‚æ­¥æ“ä½œï¼Œå°±ä¼šä¸€ç›´èµ°å¿«é€Ÿè·¯å¾„ï¼Œ`MoveNext()` æ–¹æ³•ä»å¤´åˆ°å°¾å°±åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚

çœ‹åˆ°è¿™é‡Œï¼Œç›¸ä¿¡å¤§å®¶éƒ½å¯ä»¥è¯»æ‡‚ä¸Šé¢ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹äº†ï¼Œä¹Ÿå°±çœ‹æ‡‚äº†çŠ¶æ€æœºï¼Œä¹Ÿå°±çŸ¥é“äº† C# å¼‚æ­¥çš„å®ç°ã€‚

æ€»ç»“ä¸€ä¸‹æœ€é‡è¦çš„ `MoveNext()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å·¥ä½œï¼š
1. ä»æ­£ç¡®çš„ä½ç½®å¼€å§‹æ‰§è¡Œï¼ˆèµ·å§‹ä½ç½®æˆ–ä¸­é—´ä½ç½®ï¼Œå‡èƒ½æ­£ç¡®æ‰§è¡Œï¼‰
2. å³å°†æš‚åœæ—¶ä¿å­˜çŠ¶æ€ï¼ˆä¸ºçŠ¶æ€æœºç»“æ„ä½“å¯¹è±¡çš„ stateï¼Œawaiter ä»¥åŠå…¶å®ƒå˜é‡èµ‹å€¼ï¼‰
3. éœ€è¦æš‚åœæ—¶å®‰æ’ä¸€ä¸ªç»­å»¶ï¼ˆä¸º state èµ‹å€¼å³å®‰æ’ç»­å»¶ï¼Œå› ä¸º `MoveNext()` è¢«é‡æ–°è°ƒç”¨åä¼šæ ¹æ® state çš„å€¼é€‰æ‹©æ¥ä¸‹æ¥è¦è¿è¡Œçš„ä»£ç å—ï¼Œä¹Ÿå°±æ˜¯ç»­å»¶ï¼‰
4. ä» awaiter è·å¾—è¿”å›å€¼ï¼ˆä¸Šä¾‹ä¸­æ²¡æœ‰ await è¯­å¥è¿”å›å€¼ï¼Œåªæœ‰è‹ç™½çš„ `awaiter2.GetResult();` è¿™ç§è¯­å¥ï¼Œæ²¡æ˜ç¡®ä½“ç°å‡ºæ¥ï¼Œä¸è¿‡ä¸å½±å“æˆ‘ä»¬ç†è§£å¼‚æ­¥çš„å®ç°ï¼‰
5. é€šè¿‡ builder ç”Ÿæˆå¼‚å¸¸ã€‚catch ä½å¼‚å¸¸åæ‰§è¡Œäº†è¿™äº›ä»£ç ï¼š
   ```c#
   this.state = -2;
   this.builder.SetException(exception); // é€šè¿‡ builder å¡«å……å¼‚å¸¸ä¿¡æ¯
   return; // ç›´æ¥ returnï¼Œå¹¶æ²¡æœ‰ throw
   ```
   åªæ˜¯é€šè¿‡ builder æ¥ Set äº†å¼‚å¸¸ï¼Œç„¶åå°± return äº†ï¼Œå¹¶æ²¡æœ‰é‡æ–° throw å‡ºå¼‚å¸¸ï¼ˆåªæœ‰ StackOverflowException æˆ– ThreadAbortException ç­‰ç‰¹æ®Šå¼‚å¸¸æ‰ä¼šç›´æ¥è¢«æŠ›å‡ºå»ï¼‰
6. é€šè¿‡ builder ç”Ÿæˆè¿”å›å€¼æˆ–å®Œæˆæ–¹æ³•

åˆ°ç°åœ¨ï¼ŒC# å¼‚æ­¥çš„å®ç°éƒ¨åˆ†å·²ç»åŸºæœ¬æ‰¯å®Œäº†ã€‚çœ‹åˆ°è¿™é‡Œå‰é¢ç•™ä¸‹çš„é—®é¢˜ï¼šä¸ºä»€ä¹ˆâ€œå°šæœªå¯åŠ¨â€å’Œâ€œæ­£åœ¨æ‰§è¡Œâ€çŠ¶æ€ç”¨åŒä¸€ä¸ªå€¼è¡¨ç¤ºï¼Ÿä¹Ÿå·²ç»æœ‰ç­”æ¡ˆäº†ã€‚å› ä¸ºæ­£å¸¸æƒ…å†µä¸‹ `MoveNext()` åªä¼šåœ¨çŠ¶æ€æœºåˆšå¯åŠ¨æˆ–è€…æ¢å¤æ‰§è¡Œçš„æ—¶å€™è¢«è°ƒç”¨ï¼Œæ‰€ä»¥â€œå°šæœªå¯åŠ¨â€å’Œâ€œæ­£åœ¨æ‰§è¡Œâ€å¯ä»¥ç”¨åŒä¸€ä¸ªçŠ¶æ€ç è¡¨ç¤ºã€‚

### å¼‚æ­¥æ–¹æ³•çš„æµç¨‹å›¾

æœ€åæˆ‘æŠŠ *C# in Depth, Fourth Edition* é‡Œçš„å¼‚æ­¥æ–¹æ³•çš„æµç¨‹å›¾æè¿‡æ¥äº†ï¼š

|![å›¾ 2 - MoveNext æ–¹æ³•æµç¨‹å›¾](assets/2022-08-13-19-19-25.png)|
|:--:|
|<b>å›¾ 2 - MoveNext æ–¹æ³•æµç¨‹å›¾</b>|

è°ƒç”¨ `SetStateMachine()` æ–¹æ³•ä»¥åŠ try-catch æ²¡æœ‰æ”¾åˆ°æµç¨‹å›¾ä¸­ï¼Œä½†ä¸å½±å“ç†è§£ã€‚

## æ€»ç»“

çŸ¥é“äº† C# å¦‚ä½•å®ç°å¼‚æ­¥ä¹‹åï¼Œæˆ‘ä»¬å°±èƒ½å½»åº•æ•´æ˜ç™½ `await` è¿™ç§çœ‹èµ·æ¥å¾ˆç®€å•å®é™…ä¸Šå¾ˆå¤æ‚çš„è¡¨è¾¾å¼åˆ°åº•åšäº†ä»€ä¹ˆäº†ã€‚åé¢æœ‰æ—¶é—´çš„è¯æˆ‘å†å†™ä¸€ä¸‹ã€‚
